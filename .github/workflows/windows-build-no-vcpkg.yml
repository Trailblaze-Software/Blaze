---
name: Windows Build (No vcpkg)
on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]
  workflow_dispatch: {}
jobs:
  windows-build-cli:
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - name: Install Chocolatey
        shell: pwsh
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          $protocol = [System.Net.ServicePointManager]::SecurityProtocol
          [System.Net.ServicePointManager]::SecurityProtocol = $protocol -bor 3072
          $installScript = 'https://community.chocolatey.org/install.ps1'
          iex ((New-Object System.Net.WebClient).DownloadString($installScript))
          choco --version
      - name: Install build tools
        shell: pwsh
        run: |
          choco install -y cmake --installargs 'ADD_CMAKE_TO_PATH=System'
          choco install -y git
          refreshenv
      - name: Install GDAL
        shell: pwsh
        run: |
          choco install -y gdal
          refreshenv
      - name: Install OpenCV
        shell: pwsh
        run: |
          choco install -y opencv
          refreshenv
      - name: Find installed packages and setup CMake paths
        shell: pwsh
        run: |
          # Find GDAL installation
          $gdalPaths = @(
            "C:\Program Files\GDAL",
            "C:\OSGeo4W64",
            "$env:ProgramFiles\GDAL"
          )
          $gdalPath = $null
          foreach ($path in $gdalPaths) {
            if (Test-Path $path) {
              $gdalPath = $path
              break
            }
          }

          # Find OpenCV installation
          $opencvPaths = @(
            "C:\tools\opencv",
            "C:\opencv",
            "$env:ProgramFiles\opencv"
          )
          $opencvPath = $null
          foreach ($path in $opencvPaths) {
            if (Test-Path $path) {
              $opencvPath = $path
              break
            }
          }

          Write-Host "Found GDAL at: $gdalPath"
          Write-Host "Found OpenCV at: $opencvPath"

          # Build CMAKE_PREFIX_PATH
          $cmakePrefixPaths = @()
          if ($gdalPath) {
            $cmakePrefixPaths += $gdalPath
            # Try to find GDAL cmake config
            $gdalCmakePath = Join-Path $gdalPath "cmake\gdal"
            if (Test-Path $gdalCmakePath) {
              echo "GDAL_DIR=$gdalCmakePath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            }
          }
          if ($opencvPath) {
            $cmakePrefixPaths += $opencvPath
            # OpenCV_DIR should point to the build directory or root
            $opencvBuildPath = Join-Path $opencvPath "build"
            if (Test-Path $opencvBuildPath) {
              echo "OpenCV_DIR=$opencvBuildPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            } else {
              echo "OpenCV_DIR=$opencvPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            }
          }

          if ($cmakePrefixPaths.Count -gt 0) {
            $cmakePrefixPath = $cmakePrefixPaths -join ";"
            echo "CMAKE_PREFIX_PATH=$cmakePrefixPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            Write-Host "Set CMAKE_PREFIX_PATH=$cmakePrefixPath"
          }
      - name: Configure (CLI only)
        shell: pwsh
        run: |
          cmake -B build -DBLAZE_USE_VCPKG=OFF -DBLAZE_CLI_ONLY=ON -DCMAKE_BUILD_TYPE=Release
      - name: Build
        shell: pwsh
        run: |
          cmake --build build --config Release --parallel
      - name: Run tests
        shell: pwsh
        run: |
          cmake --build build --target test
